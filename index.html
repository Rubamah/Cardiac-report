<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Pharmacy Tickets â€” Realtime Dashboard</title>

<style>
  :root{
    --bg:#0b1320; --card:#111a2b; --ink:#eaf2ff; --muted:#94a3b8;
    --accent:#14b8a6; --border:#1f2a44; --head:#0f1626;
    --okbg:#0e2e2a; --okbd:#1a5e56; --oktx:#8ff3e5;
    --pbg:#2b2040; --pbd:#57468a; --ptx:#d3b3ff;
    --dbg:#3a1616; --dbd:#6b2323; --dtx:#ffb3b3;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 18px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,#0f172a,#0b1320)}
  header h1{margin:0;font-size:20px;letter-spacing:.3px}
  .wrap{max-width:1400px;margin:auto;padding:18px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;color:var(--muted)}
  .stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .stat b{color:#fff}
  .filters{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end;margin-top:8px}
  .field{grid-column:span 3;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .field input{width:100%;background:#0a1220;border:1px solid #23314f;color:var(--ink);padding:8px 10px;border-radius:8px;outline:none}
  .actions{grid-column:span 3;display:flex;gap:8px}
  button{border:1px solid var(--border);background:#0f1a2e;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .grid{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  thead th{position:sticky;top:0;background:var(--head);color:#bcd0f7;font-weight:700;text-align:center;padding:12px;border-bottom:1px solid #203056}
  tbody td{padding:10px 8px;border-bottom:1px solid #16213a;text-align:center;font-variant-numeric:tabular-nums}
  tr:hover td{background:#0e172a80}
  .badge{display:inline-block;padding:.2em .55em;border-radius:.6em;font-size:.85em}
  .ok{background:var(--okbg);color:var(--oktx);border:1px solid var(--okbd)}
  .pending{background:var(--pbg);color:var(--ptx);border:1px solid var(--pbd)}
  .danger{background:var(--dbg);color:var(--dtx);border:1px solid var(--dbd)}
  .foot{margin-top:10px;color:var(--muted);font-size:12px}
  /* Password overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#fff}
  .overlay input{padding:12px 16px;font-size:18px;border-radius:10px;border:1px solid #333;text-align:center;margin:10px 0;width:min(280px,80vw)}
  .overlay button{background:#2563eb;color:#fff;border:0;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  .overlay .msg{color:#f99;margin-top:6px;min-height:1.2em}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
<header><h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© â€” Cardiac Pharmacy Tickets</h1></header>

<!-- PASSWORD gate (ÙŠØ·Ù„Ø¨ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·Ø› Ø§Ù„Ø±ÙØ±Ø´ Ù„Ø§) -->
<div id="gate" class="overlay" style="display:none">
  <h2>ğŸ”’ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
  <input id="pw" type="password" placeholder="Password" />
  <button id="goBtn">Ø¯Ø®ÙˆÙ„</button>
  <div id="pwMsg" class="msg"></div>
</div>

<div id="app" class="wrap" style="display:none">
  <!-- Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙÙ„Ø§ØªØ± -->
  <div class="bar">
    <span class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ°Ø§ÙƒØ±: <b id="statTotal">0</b></span>
    <span class="stat">Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹Ø©: <b id="statPrinted">0</b></span>
    <span class="stat">Ø§Ù„Ù…Ø®Ø¯Ù‘Ù…Ø©: <b id="statServed">0</b></span>
    <span class="stat">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: <b id="statWaiting">0</b></span>
  </div>

  <!-- ÙÙ„Ø§ØªØ± -->
  <div class="filters">
    <div class="field"><label for="fMrn">Ø¨Ø­Ø« Ø­Ø³Ø¨ MRN</label><input id="fMrn" placeholder="Ù…Ø«Ø§Ù„: 123456" inputmode="numeric" /></div>
    <div class="field"><label for="fTicket">Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©</label><input id="fTicket" placeholder="Ù…Ø«Ø§Ù„: 87" inputmode="numeric" /></div>
    <div class="field"><label for="fDate">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)</label><input id="fDate" type="date" /></div>
    <div class="actions">
      <button id="btnClear">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      <button id="btnExport">ØªØµØ¯ÙŠØ± CSV</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
  <div class="grid">
    <table>
      <thead><tr>
        <th>Ticket</th><th>MRN</th><th>Printed Time</th><th>Served Time</th><th>Waiting Time</th><th>Status</th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="foot">Ø§Ù„Ø­Ø§Ù„Ø©: <span class="badge ok">Served</span> / <span class="badge pending">Printed</span> / <span class="badge danger">No time</span>. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ.</div>
</div>

<script>
/* ========= Password gate =========
   - Ù†Ø®Ø²Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ sessionStorage â†’ ÙŠÙ†Ø¬Ùˆ Ù…Ø¹ refresh
   - ÙŠÙ†Ù…Ø³Ø­ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ â†’ Ø³ÙŠÙØ·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ Ù…Ø¬Ø¯Ø¯Ù‹Ø§
*/
const PASS_KEY='phReportOK', PASS_VAL='1', PASSWORD='PhReport';
(function gate(){
  const ok = sessionStorage.getItem(PASS_KEY)===PASS_VAL;
  const gateEl=document.getElementById('gate'), appEl=document.getElementById('app');
  if(!ok){
    gateEl.style.display='flex'; appEl.style.display='none';
    document.getElementById('goBtn').onclick=()=>{
      const v=(document.getElementById('pw').value||'').trim();
      const msg=document.getElementById('pwMsg');
      if(v===PASSWORD){
        sessionStorage.setItem(PASS_KEY,PASS_VAL);
        gateEl.remove(); appEl.style.display='block'; startApp();
      }else{ msg.textContent='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; }
    };
  }else{ gateEl.remove(); appEl.style.display='block'; startApp(); }
})();

/* ========= Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========= */
function startApp(){
  // 1) Firebase
  const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT='cardiac_demo'; // Ø«Ø§Ø¨Øª

  // 2) Ø¹Ù†Ø§ØµØ±
  const tbody=document.getElementById('tbody');
  const statTotal=document.getElementById('statTotal');
  const statPrinted=document.getElementById('statPrinted');
  const statServed=document.getElementById('statServed');
  const statWaiting=document.getElementById('statWaiting');
  const fMrn=document.getElementById('fMrn');
  const fTk=document.getElementById('fTicket');
  const fDate=document.getElementById('fDate');
  document.getElementById('btnClear').onclick=()=>{ fMrn.value=''; fTk.value=''; setToday(); render(); };
  document.getElementById('btnExport').onclick=exportCSV;
  fMrn.addEventListener('input', render);
  fTk.addEventListener('input', render);
  fDate.addEventListener('change', render);

  // 3) Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ = Ø§Ù„ÙŠÙˆÙ…
  function setToday(){
    const now=new Date(); const y=now.getFullYear();
    const m=String(now.getMonth()+1).padStart(2,'0');
    const d=String(now.getDate()).padStart(2,'0');
    fDate.value=`${y}-${m}-${d}`;
  }
  setToday();

  // 4) Utilities
  const rows=new Map(); // key=ticket
  function zp(n){return n<10?('0'+n):(''+n);}
  function fmt(iso){ if(!iso) return ''; const d=new Date(iso); if(isNaN(d)) return ''; return `${d.getFullYear()}-${zp(d.getMonth()+1)}-${zp(d.getDate())} ${zp(d.getHours())}:${zp(d.getMinutes())}:${zp(d.getSeconds())}`; }
  function sameDate(iso,ymd){ if(!iso||!ymd) return true; const d=new Date(iso); if(isNaN(d)) return false; return d.toISOString().slice(0,10)===ymd; }
  // ÙŠÙ‚Ø¨Ù„ {ts} Ø£Ùˆ Ø±Ù‚Ù… ms Ø£Ùˆ ISO
  function coerce(raw){
    if(raw==null) return null;
    if(typeof raw==='string'){ const d=new Date(raw); return isNaN(d)?null:d.toISOString(); }
    if(typeof raw==='number'){ const d=new Date(raw); return isNaN(d)?null:d.toISOString(); }
    if(typeof raw==='object' && raw.ts!=null){ const d=new Date(raw.ts); return isNaN(d)?null:d.toISOString(); }
    return null;
  }
  // Ø®Ø¯Ù…Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø© ÙÙ‚Ø· Ø¥Ù† ÙƒØ§Ù†Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  function isValidServed(rec){
    if(!rec.tServed || !rec.tPrinted) return false;
    const s=new Date(rec.tServed).getTime(), p=new Date(rec.tPrinted).getTime();
    return !Number.isNaN(s) && !Number.isNaN(p) && s>=p;
  }
  // Ø²Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
  function waitingMs(rec){
    const p = rec.tPrinted ? new Date(rec.tPrinted).getTime() : NaN;
    const end = isValidServed(rec) ? new Date(rec.tServed).getTime() : Date.now();
    return Number.isNaN(p) ? NaN : Math.max(0,end-p);
  }
  function dur(ms){
    if(Number.isNaN(ms)) return '';
    const s=Math.floor(ms/1000);
    return `${zp(Math.floor(s/3600))}:${zp(Math.floor((s%3600)/60))}:${zp(s%60)}`;
  }

  /* ===== Sticky merge: ØªØ­Ø¯ÙŠØ« Ø­ÙŠ Ø¨Ø¯ÙˆÙ† Ù†Ø²ÙˆÙ„ Ø­Ø§Ù„Ø© Ø£Ùˆ Ø­Ø°Ù ===== */
  function isEmpty(v){ return v===undefined || v===null || v===false || v==='' }
  function mergeSticky(rec, patch){
    // Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨ØªØµÙÙŠØ± printed/served Ø¨Ø¹Ø¯ Ø±ÙØ¹Ù‡Ø§
    if (!isEmpty(patch.printed) && patch.printed===true) rec.printed = true;
    if (!isEmpty(patch.served)  && patch.served ===true) rec.served  = true;

    // Ø£ÙˆÙ„ Ø·Ø§Ø¨Ø¹ Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·
    if (!isEmpty(patch.tPrinted) && !rec.tPrinted) rec.tPrinted = patch.tPrinted;

    // Ø£ÙˆÙ„ Ø·Ø§Ø¨Ø¹ Ø®Ø¯Ù…Ø© ØµØ§Ù„Ø­ ÙÙ‚Ø· (Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)
    if (!isEmpty(patch.tServed) && !rec.tServed) {
      const tmp = { tPrinted: rec.tPrinted || patch.tPrinted || null, tServed: patch.tServed };
      if (isValidServed(tmp)) rec.tServed = patch.tServed;
    }

    // MRN Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© ØºÙŠØ± ÙØ§Ø¶ÙŠØ© ÙÙ‚Ø·
    if (!isEmpty(patch.mrn) && !rec.mrn) rec.mrn = String(patch.mrn);
    return rec;
  }
  function upsert(id,patch){
    const rec = rows.get(id) || {ticket:id,mrn:'',printed:false,served:false,tPrinted:null,tServed:null};
    mergeSticky(rec, patch);
    rows.set(id, rec);
    render();
  }

  // 5) Ø§Ù„ØªØ­Ù…ÙŠÙ„/Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† â€” Ù„Ø§ Ù†Ù†Ø´Ø¦ ØµÙÙ‹Ø§ Ø¥Ù„Ø§ Ù…Ù† printedØŒ ÙˆÙ†Ø±ÙØ¶ Ø£ÙŠ ØªØ®ÙÙŠØ¶/Ø­Ø°Ù
  const rPrinted=db.ref(`${ROOT}/printed`);
  const rTP=db.ref(`${ROOT}/times/printed`);
  const rServed=db.ref(`${ROOT}/served`);
  const rTS=db.ref(`${ROOT}/times/served`);
  const rCalls=db.ref(`${ROOT}/calls`);
  const rTickets=db.ref(`${ROOT}/tickets`);

  // printed: Ù„Ø§ ØµÙ Ø¨Ø¯ÙˆÙ† Ø·Ø¨Ø§Ø¹Ø©. Ù†ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙØ§Ø±Øº/false
  rPrinted.on('child_added', (c)=>{
    const tp = coerce(c.val());
    if (tp) upsert(c.key, { printed:true, tPrinted:tp });
  });
  rPrinted.on('child_changed', (c)=>{
    const tp = coerce(c.val());
    if (tp) upsert(c.key, { printed:true, tPrinted:tp });
    // Ù„Ùˆ tp ÙØ§Ø¶ÙŠ/ØºÙŠØ± ØµØ§Ù„Ø­ â†’ Ù†ØªØ¬Ø§Ù‡Ù„ (Ù„Ø§ Ù†Ù†Ø²Ù„ Ø§Ù„Ø­Ø§Ù„Ø©)
  });

  // times/printed: Ù†Ø«Ø¨Ù‘Øª Ø£ÙˆÙ„ Ø·Ø§Ø¨Ø¹ ÙÙ‚Ø·
  rTP.on('child_added', (c)=>{
    const tp = coerce(c.val());
    if (rows.has(c.key) && tp) upsert(c.key, { tPrinted:tp });
  });
  rTP.on('child_changed', (c)=>{
    const tp = coerce(c.val());
    if (rows.has(c.key) && tp) upsert(c.key, { tPrinted:tp });
  });

  // served: Ù†Ø±ÙØ¹ Ù„Ù€ true ÙÙ‚Ø·ØŒ ÙˆÙ†ØªØ¬Ø§Ù‡Ù„ false/null
  rServed.on('child_added', (c)=>{
    if (rows.has(c.key) && c.val()) upsert(c.key, { served:true });
  });
  rServed.on('child_changed', (c)=>{
    if (rows.has(c.key) && c.val()) upsert(c.key, { served:true });
  });

  // calls: Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ Ø·Ø§Ø¨Ø¹ Ø®Ø¯Ù…Ø© ØµØ§Ù„Ø­ ÙÙ‚Ø·
  rCalls.on('child_added', (c)=>{
    const ts = coerce(c.val());
    if (rows.has(c.key) && ts) upsert(c.key, { tServed:ts });
  });
  rCalls.on('child_changed', (c)=>{
    const ts = coerce(c.val());
    if (rows.has(c.key) && ts) upsert(c.key, { tServed:ts });
  });

  // times/served: Ù†ÙØ³ Ø§Ù„Ø´ÙŠØ¡ (Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© ØµØ§Ù„Ø­Ø© ÙÙ‚Ø·)
  rTS.on('child_added', (c)=>{
    const ts = coerce(c.val());
    if (rows.has(c.key) && ts) upsert(c.key, { tServed:ts });
  });
  rTS.on('child_changed', (c)=>{
    const ts = coerce(c.val());
    if (rows.has(c.key) && ts) upsert(c.key, { tServed:ts });
  });

  // tickets (MRN): Ù†Ø«Ø¨Ù‘Øª Ø£ÙˆÙ„ MRN ÙÙ‚Ø· ÙˆÙ„Ø§ Ù†Ù†Ø²Ù„ Ù„Ù‚ÙŠÙ…Ø© ÙØ§Ø¶ÙŠØ©
  rTickets.on('child_added', (c)=>{
    if (!rows.has(c.key)) return;
    const v = c.val();
    const m = (v && v.mrn!=null) ? String(v.mrn) : '';
    if (m) upsert(c.key, { mrn:m });
  });
  rTickets.on('child_changed', (c)=>{
    if (!rows.has(c.key)) return;
    const v = c.val();
    const m = (v && v.mrn!=null) ? String(v.mrn) : '';
    if (m) upsert(c.key, { mrn:m });
  });

  // 6) Render Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙÙ„ØªØ±Ø©ØŒ ÙˆØ­Ø§Ù„Ø© Served Ù…Ù†Ø·Ù‚ÙŠØ©
  function render(){
    const mrnF=fMrn.value.trim();
    const tkF=fTk.value.trim();
    const dateF=fDate.value;

    // ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹Ø© ÙÙ‚Ø· + ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© + Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙÙ„Ø§ØªØ±
    const base=[...rows.values()].filter(r=>{
      const isPrinted=r.printed||!!r.tPrinted;
      if(!isPrinted) return false;
      if(dateF && r.tPrinted && !sameDate(r.tPrinted,dateF)) return false;
      if(mrnF && (!r.mrn || !String(r.mrn).includes(mrnF))) return false;
      if(tkF && String(r.ticket)!==String(tkF)) return false;
      return true;
    }).sort((a,b)=>Number(a.ticket)-Number(b.ticket));

    tbody.innerHTML=base.map(r=>{
      const served = (!!r.served) || isValidServed(r);      // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©
      const printed= (!!r.printed) || !!r.tPrinted;
      const status = served ? 'Served' : (printed ? 'Printed' : 'No time');
      const badge  = served ? 'ok'     : (printed ? 'pending' : 'danger');
      const servedCell = served ? fmt(r.tServed) : '';      // ÙŠØ¸Ù„ ÙØ§Ø¶ÙŠ Ø­ØªÙ‰ ÙŠØªÙ†Ø§Ø¯ÙÙ‰
      return `<tr>
        <td><b>#${r.ticket}</b></td>
        <td>${r.mrn || ''}</td>
        <td>${fmt(r.tPrinted)}</td>
        <td>${servedCell}</td>
        <td>${dur( waitingMs(r) )}</td>
        <td><span class="badge ${badge}">${status}</span></td>
      </tr>`;
    }).join('');

    // Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ (ØªØ§Ø±ÙŠØ®/ÙÙ„Ø§ØªØ± ÙÙ‚Ø·)
    statTotal.textContent   = base.length;
    statPrinted.textContent = base.filter(r=> r.printed || !!r.tPrinted).length;
    statServed.textContent  = base.filter(r=> (!!r.served) || isValidServed(r)).length;
    statWaiting.textContent = base.filter(r=>{
      const p=(r.printed||!!r.tPrinted), s=(!!r.served)||isValidServed(r);
      return p && !s;
    }).length;
  }

  // ØªØ­Ø¯ÙŠØ« WT ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© (Ø®ÙÙŠÙ ÙˆØ¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ ÙÙ‚Ø·)
  setInterval(render, 1000);

  // ØªØµØ¯ÙŠØ± CSV Ù„Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
  function exportCSV(){
    const headers=['Ticket','MRN','Printed Time','Served Time','Waiting Time (HH:MM:SS)','Status'];
    const out=[headers.join(',')];
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const vals=Array.from(tr.children).map(td=> td.innerText.trim());
      out.push(vals.map(x=> `"${x.replace(/"/g,'""')}"`).join(','));
    });
    const name=`cardiac_dashboard_${(document.getElementById('fDate').value||'all')}.csv`;
    const blob=new Blob([out.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove();
  }
}
</script>
</body>
</html>
