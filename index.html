<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Pharmacy — Realtime Dashboard</title>

<style>
  :root{
    --bg:#0b1320; --card:#111a2b; --ink:#eaf2ff; --muted:#94a3b8;
    --accent:#14b8a6; --border:#1f2a44; --head:#0f1626;
    --okbg:#0e2e2a; --okbd:#1a5e56; --oktx:#8ff3e5;
    --pbg:#2b2040; --pbd:#57468a; --ptx:#d3b3ff;
    --dbg:#3a1616; --dbd:#6b2323; --dtx:#ffb3b3;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 18px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,#0f172a,#0b1320)}
  header h1{margin:0;font-size:20px;letter-spacing:.3px}
  .wrap{max-width:1400px;margin:auto;padding:18px}

  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;color:var(--muted)}
  .stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .stat b{color:#fff}
  button{border:1px solid var(--border);background:#0f1a2e;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);border-color:#0e9e8f;color:#082c2a;font-weight:800}
  .filters{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end;margin-top:8px}
  .field{grid-column:span 3;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .field input{width:100%;background:#0a1220;border:1px solid #23314f;color:var(--ink);padding:8px 10px;border-radius:8px;outline:none}
  .actions{grid-column:span 3;display:flex;gap:8px}
  .grid{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  thead th{position:sticky;top:0;background:var(--head);color:#bcd0f7;font-weight:700;text-align:center;padding:12px;border-bottom:1px solid #203056}
  tbody td{padding:10px 8px;border-bottom:1px solid #16213a;text-align:center;font-variant-numeric:tabular-nums}
  tr:hover td{background:#0e172a80}
  .badge{display:inline-block;padding:.2em .55em;border-radius:.6em;font-size:.85em}
  .ok{background:var(--okbg);color:var(--oktx);border:1px solid var(--okbd)}
  .pending{background:var(--pbg);color:var(--ptx);border:1px solid var(--pbd)}
  .danger{background:var(--dbg);color:var(--dtx);border:1px solid var(--dbd)}
  .foot{margin-top:10px;color:var(--muted);font-size:12px}
</style>

<!-- Firebase compat (مطابق لملفاتك الحالية) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
<header>
  <h1>لوحة المتابعة اللحظية — Cardiac Pharmacy Tickets</h1>
</header>

<div class="wrap">
  <!-- أزرار تغيير الجذر + إحصاءات -->
  <div class="bar">
    <span>المسار:</span>
    <button id="rootDemo" class="primary">cardiac_demo</button>
    <button id="rootProd">cardiac</button>
    <span id="rootLabel" class="stat">المسار الحالي: <b>cardiac_demo</b></span>
    <span class="stat">إجمالي التذاكر: <b id="statTotal">0</b></span>
    <span class="stat">المطبوعة: <b id="statPrinted">0</b></span>
    <span class="stat">المخدّمة: <b id="statServed">0</b></span>
    <span class="stat">قيد الانتظار: <b id="statWaiting">0</b></span>
  </div>

  <!-- فلاتر -->
  <div class="filters">
    <div class="field">
      <label for="fMrn">بحث حسب MRN</label>
      <input id="fMrn" placeholder="مثال: 123456" inputmode="numeric" />
    </div>
    <div class="field">
      <label for="fTicket">بحث حسب رقم التذكرة</label>
      <input id="fTicket" placeholder="مثال: 87" inputmode="numeric" />
    </div>
    <div class="field">
      <label for="fDate">التاريخ (حسب وقت الطباعة)</label>
      <input id="fDate" type="date" />
    </div>
    <div class="actions">
      <button id="btnClear">مسح الفلاتر</button>
      <button id="btnExport">تصدير CSV</button>
    </div>
  </div>

  <!-- الجدول -->
  <div class="grid">
    <table>
      <thead>
        <tr>
          <th>Ticket</th>
          <th>MRN</th>
          <th>Printed Time</th>
          <th>Served Time</th>
          <th>Waiting Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="foot">
    الحالة: <span class="badge ok">Served</span> / <span class="badge pending">Printed</span> / <span class="badge danger">No time</span>. التحديث لحظي.
  </div>
</div>

<script>
/* ========== 1) إعداد Firebase ========== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========== 2) اختيار الجذر (cardiac_demo/cardiac) ========== */
let OPERATOR_ROOT = 'cardiac_demo';
const rootLabel = document.getElementById('rootLabel');
document.getElementById('rootDemo').onclick = ()=> switchRoot('cardiac_demo');
document.getElementById('rootProd').onclick = ()=> switchRoot('cardiac');
function switchRoot(r){
  OPERATOR_ROOT = r;
  rootLabel.innerHTML = `المسار الحالي: <b>${r}</b>`;
  loadAll();
}

/* ========== 3) عناصر الواجهة ========== */
const tbody = document.getElementById('tbody');
const statTotal   = document.getElementById('statTotal');
const statPrinted = document.getElementById('statPrinted');
const statServed  = document.getElementById('statServed');
const statWaiting = document.getElementById('statWaiting');

const fMrn   = document.getElementById('fMrn');
const fTk    = document.getElementById('fTicket');
const fDate  = document.getElementById('fDate');
const btnClear  = document.getElementById('btnClear');
const btnExport = document.getElementById('btnExport');

fMrn.addEventListener('input', render);
fTk.addEventListener('input', render);
fDate.addEventListener('change', render);
btnClear.addEventListener('click', ()=>{ fMrn.value=''; fTk.value=''; fDate.value=''; render(); });
btnExport.addEventListener('click', exportCSV);

/* ========== 4) Utilities ========== */
const rows = new Map(); // key=ticket, value={ticket,mrn,printed,served,tPrinted,tServed}

function zeroPad(n){ return n<10?('0'+n):(''+n); }
function fmtISO(iso){
  if(!iso) return '';
  const d = new Date(iso);
  if(isNaN(d)) return '';
  const yyyy = d.getFullYear();
  const mm   = zeroPad(d.getMonth()+1);
  const dd   = zeroPad(d.getDate());
  const hh   = zeroPad(d.getHours());
  const mi   = zeroPad(d.getMinutes());
  const ss   = zeroPad(d.getSeconds());
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}
function sameDate(iso, ymd){
  if(!iso || !ymd) return true;
  const d = new Date(iso);
  if(isNaN(d)) return false;
  const y = d.getFullYear(), m = zeroPad(d.getMonth()+1), da = zeroPad(d.getDate());
  return `${y}-${m}-${da}` === ymd;
}

// يقبل string ISO أو رقم ms أو كائن {ts}
function coerceTime(raw){
  if(raw==null) return null;
  if(typeof raw==='string'){
    const d=new Date(raw); return isNaN(d)? null : d.toISOString();
  }
  if(typeof raw==='number'){
    const d=new Date(raw); return isNaN(d)? null : d.toISOString();
  }
  if(typeof raw==='object' && raw.ts!=null){
    const d=new Date(raw.ts); return isNaN(d)? null : d.toISOString();
  }
  return null;
}

function waitingMs(rec){
  const start = rec.tPrinted ? new Date(rec.tPrinted).getTime() : NaN;
  if(Number.isNaN(start)) return NaN;
  const end = rec.tServed ? new Date(rec.tServed).getTime() : Date.now();
  return Math.max(0, end - start);
}
function durFmt(ms){
  if(Number.isNaN(ms)) return '';
  const s = Math.floor(ms/1000);
  const hh = zeroPad(Math.floor(s/3600));
  const mm = zeroPad(Math.floor((s%3600)/60));
  const ss = zeroPad(s%60);
  return `${hh}:${mm}:${ss}`;
}

/* ========== 5) قراءة مبدئية + مستمعين لحظيين ========== */
let unsubscribers = [];
function offAll(){
  unsubscribers.forEach(u=> u && u.off && u.off());
  unsubscribers = [];
}

async function loadAll(){
  offAll();
  rows.clear();
  tbody.innerHTML='';

  const refPrinted = db.ref(`${OPERATOR_ROOT}/printed`);
  const refServed  = db.ref(`${OPERATOR_ROOT}/served`);
  const refMrn     = db.ref(`${OPERATOR_ROOT}/mrn`);
  const refTP      = db.ref(`${OPERATOR_ROOT}/times/printed`);
  const refTS      = db.ref(`${OPERATOR_ROOT}/times/served`);

  const [sp, ss, sm, stp, sts] = await Promise.all([
    refPrinted.get(), refServed.get(), refMrn.get(), refTP.get(), refTS.get()
  ]);

  // 5.1 علّمي printed/served + استخلص وقت مضمّن إن وجد
  function mergePrintedServedSnapshot(snap, assignFlag, assignTime){
    if(!snap.exists()) return;
    const obj = snap.val();
    Object.keys(obj).forEach(ticket=>{
      const rec = rows.get(ticket) || { ticket, mrn:'', printed:false, served:false, tPrinted:null, tServed:null };
      const v = obj[ticket];
      rec[assignFlag] = !!v;
      const embeddedIso = coerceTime(v);
      if(embeddedIso) rec[assignTime] = embeddedIso;
      rows.set(ticket, rec);
    });
  }
  mergePrintedServedSnapshot(sp, 'printed', 'tPrinted');
  mergePrintedServedSnapshot(ss, 'served',  'tServed');

  // 5.2 MRN
  if(sm.exists()){
    const obj = sm.val();
    Object.keys(obj).forEach(ticket=>{
      const rec = rows.get(ticket) || { ticket, mrn:'', printed:false, served:false, tPrinted:null, tServed:null };
      rec.mrn = obj[ticket] ?? '';
      rows.set(ticket, rec);
    });
  }

  // 5.3 أولوية لمسارات times/*
  function mergeTimesSnapshot(snap, assignTime){
    if(!snap.exists()) return;
    const obj = snap.val();
    Object.keys(obj).forEach(ticket=>{
      const rec = rows.get(ticket) || { ticket, mrn:'', printed:false, served:false, tPrinted:null, tServed:null };
      const iso = coerceTime(obj[ticket]);
      if(iso) rec[assignTime] = iso;
      rows.set(ticket, rec);
    });
  }
  mergeTimesSnapshot(stp, 'tPrinted');
  mergeTimesSnapshot(sts, 'tServed');

  render();

  /* مستمعين لحظيين مع مرونة القيم */
  refPrinted.on('child_added',  c=> upsert(c.key, { printed:true,  tPrinted: coerceTime(c.val()) || rows.get(c.key)?.tPrinted || null }));
  refPrinted.on('child_changed',c=> upsert(c.key, { printed:!!c.val(), tPrinted: coerceTime(c.val()) || rows.get(c.key)?.tPrinted || null }));

  refServed.on('child_added',   c=> upsert(c.key, { served:true,   tServed:  coerceTime(c.val()) || rows.get(c.key)?.tServed  || null }));
  refServed.on('child_changed', c=> upsert(c.key, { served:!!c.val(), tServed: coerceTime(c.val()) || rows.get(c.key)?.tServed  || null }));

  refMrn.on('child_added',      c=> upsert(c.key, { mrn: c.val()||'' }));
  refMrn.on('child_changed',    c=> upsert(c.key, { mrn: c.val()||'' }));

  refTP.on('child_added',       c=> upsert(c.key, { tPrinted: coerceTime(c.val()) || null }));
  refTP.on('child_changed',     c=> upsert(c.key, { tPrinted: coerceTime(c.val()) || null }));
  refTS.on('child_added',       c=> upsert(c.key, { tServed:  coerceTime(c.val()) || null }));
  refTS.on('child_changed',     c=> upsert(c.key, { tServed:  coerceTime(c.val()) || null }));

  // للايقاف لاحقًا عند تبديل الجذر
  unsubscribers.push(refPrinted, refServed, refMrn, refTP, refTS);
}

function upsert(ticket, patch){
  const rec = rows.get(ticket) || { ticket, mrn:'', printed:false, served:false, tPrinted:null, tServed:null };
  Object.assign(rec, patch);
  rows.set(ticket, rec);
  render();
}

/* ========== 6) الرندرة + الإحصاءات ========== */
function render(){
  const mrnF = fMrn.value.trim();
  const tkF  = fTk.value.trim();
  const dateF= fDate.value; // yyyy-mm-dd

  const arr = Array.from(rows.values()).sort((a,b)=> Number(a.ticket)-Number(b.ticket));

  let printedCount=0, servedCount=0, waitingCount=0;

  const filtered = arr.filter(rec=>{
    const wasPrinted = rec.printed || !!rec.tPrinted;
    const wasServed  = rec.served  || !!rec.tServed;
    const passMrn = !mrnF || String(rec.mrn||'').includes(mrnF);
    const passTk  = !tkF  || String(rec.ticket).includes(tkF);
    const passDt  = !dateF || (rec.tPrinted && sameDate(rec.tPrinted, dateF));

    if(wasPrinted) printedCount++;
    if(wasServed)  servedCount++;
    if(wasPrinted && !wasServed) waitingCount++;

    return passMrn && passTk && passDt;
  });

  const html = filtered.map(rec=>{
    const wasPrinted = rec.printed || !!rec.tPrinted;
    const wasServed  = rec.served  || !!rec.tServed;

    const wms   = waitingMs(rec);
    const wtxt  = durFmt(wms);
    const ptxt  = fmtISO(rec.tPrinted);
    const stxt  = fmtISO(rec.tServed);
    const status= wasServed ? 'Served' : (wasPrinted ? 'Printed' : 'No time');
    const badge = wasServed ? 'ok'     : (wasPrinted ? 'pending' : 'danger');

    return `<tr data-ticket="${rec.ticket}">
      <td><b>#${rec.ticket}</b></td>
      <td>${rec.mrn||''}</td>
      <td>${ptxt}</td>
      <td>${stxt}</td>
      <td data-wait="${wms}">${wtxt}</td>
      <td><span class="badge ${badge}">${status}</span></td>
    </tr>`;
  }).join('');

  tbody.innerHTML = html;

  // الإجماليات تعرض العدد العام (بدون فلترة) — لو تبيها بعد فلترة، غيّري هنا
  const all = arr;
  statTotal.textContent   = all.length;
  statPrinted.textContent = all.filter(r=> r.printed || !!r.tPrinted).length;
  statServed.textContent  = all.filter(r=> r.served  || !!r.tServed ).length;
  statWaiting.textContent = all.filter(r=>{
    const wasPrinted = r.printed || !!r.tPrinted;
    const wasServed  = r.served  || !!r.tServed;
    return wasPrinted && !wasServed;
  }).length;
}

// تحديت وقت الانتظار لحظيًا
setInterval(()=>{
  Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
    const t = tr.getAttribute('data-ticket');
    const rec = rows.get(t);
    if(rec){
      const ms = waitingMs(rec);
      const td = tr.querySelector('td[data-wait]');
      if(td){
        td.setAttribute('data-wait', ms);
        td.textContent = durFmt(ms);
      }
    }
  });
}, 1000);

/* ========== 7) تصدير CSV ========== */
function exportCSV(){
  const headers = ['Ticket','MRN','Printed Time','Served Time','Waiting Time (HH:MM:SS)','Status'];
  const out = [headers.join(',')];

  Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
    const vals = Array.from(tr.children).map(td=> td.innerText.trim());
    // نحتاج تحويل حالة الشارة فقط (آخر عمود)
    out.push(vals.map(x=> `"${x.replace(/"/g,'""')}"`).join(','));
  });

  const name = `cardiac_dashboard_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  const blob = new Blob([out.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ========== 8) انطلاق ========== */
loadAll();
</script>
</body>
</html>
