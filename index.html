<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pharmacy Report</title>
<style>
  body {
    background:#f5f7fb;
    font-family:-apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:#0f172a; margin:0; padding:0; text-align:center;
  }
  h1 { margin:24px 0 12px; }
  #filters {
    display:flex; flex-wrap:wrap; justify-content:center; gap:10px;
    margin:10px auto 20px; max-width:800px;
  }
  input, select, button {
    padding:10px 14px; font-size:16px; border-radius:8px; border:1px solid #cbd5e1;
  }
  table {
    width:90%; margin:20px auto; border-collapse:collapse; background:#fff;
  }
  th, td {
    padding:10px; border:1px solid #cbd5e1; text-align:center;
  }
  th { background:#2563eb; color:#fff; }
  button {
    background:#2563eb; color:#fff; border:0; cursor:pointer; font-weight:600;
  }
  #exportBtn { margin-top:20px; }
  #app { display:none; }
  /* Password Gate */
  #authGate{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.85); color:#fff; flex-direction:column;
    font-family:-apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  #authBox{
    background:#0f172a; padding:24px; border-radius:14px; width:min(400px,90%);
    box-shadow:0 10px 30px rgba(0,0,0,.5); text-align:center;
  }
  #authBox input{
    width:100%; margin-top:10px; padding:12px; font-size:18px; border-radius:8px; border:0;
    text-align:center;
  }
  #authBox button{
    margin-top:14px; width:100%; padding:12px; font-size:18px; border:0;
    background:#2563eb; color:#fff; border-radius:8px; cursor:pointer;
  }
  #authErr{ color:#fca5a5; margin-top:8px; font-size:14px; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<!-- ===== PASSWORD GATE ===== -->
<div id="authGate">
  <div id="authBox">
    <h2>Protected Report</h2>
    <p>أدخل كلمة المرور للوصول إلى التقرير</p>
    <input id="authPw" type="password" placeholder="Password" />
    <button id="authBtn">دخول</button>
    <div id="authErr"></div>
  </div>
</div>

<!-- ===== REPORT APP ===== -->
<div id="app">
  <h1>Pharmacy Report</h1>

  <div id="filters">
    <label>من: <input type="date" id="fromDate"></label>
    <label>إلى: <input type="date" id="toDate"></label>
    <input type="text" id="filterTicket" placeholder="رقم التذكرة">
    <input type="text" id="filterWindow" placeholder="الشباك">
    <input type="text" id="filterMRN" placeholder="MRN">
    <button onclick="loadReport()">عرض</button>
  </div>

  <table id="reportTable">
    <thead>
      <tr>
        <th>رقم التذكرة</th>
        <th>MRN</th>
        <th>وقت الطباعة</th>
        <th>وقت النداء</th>
        <th>الشباك</th>
        <th>مدة الانتظار (د)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="exportBtn" onclick="exportCSV()">تصدير إلى Excel (CSV)</button>
</div>

<script>
/* ========== Password Lock ========== */
(function(){
  const PASS = "PhReport";
  const KEY = "phreport_auth_ok";
  const gate = document.getElementById('authGate');
  const app = document.getElementById('app');
  const btn = document.getElementById('authBtn');
  const inp = document.getElementById('authPw');
  const err = document.getElementById('authErr');

  function unlock(){
    sessionStorage.setItem(KEY,"1");
    gate.style.display="none";
    app.style.display="block";
  }

  if(sessionStorage.getItem(KEY)==="1"){ unlock(); }
  else{
    btn.onclick = tryLogin;
    inp.onkeydown = e => { if(e.key==="Enter") tryLogin(); };
    function tryLogin(){
      if(inp.value.trim()===PASS) unlock();
      else err.textContent="كلمة المرور غير صحيحة.";
    }
  }
})();

/* ========== Firebase ========== */
const cfg = {
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db = firebase.database();
const ROOT = "cardiac_demo";

/* ========== Report Functions ========== */
async function getMrn(n){
  const s = await db.ref(`${ROOT}/mrn/${n}`).get();
  return s.exists() ? s.val() : "";
}
async function getPrintedTs(n){
  const s = await db.ref(`${ROOT}/printed/${n}`).get();
  return s.exists()? s.val() : "";
}
async function getCallData(n){
  const snap = await db.ref(`${ROOT}/calls`).orderByChild("number").equalTo(n).limitToFirst(1).get();
  let res={ts:"",window:""};
  snap.forEach(e=>{
    const v=e.val()||{};
    res.ts=v.ts||"";
    res.window=v.window||"";
  });
  return res;
}

async function loadReport(){
  const tbody=document.querySelector("#reportTable tbody");
  tbody.innerHTML="<tr><td colspan='6'>جارٍ التحميل...</td></tr>";

  const from=new Date(document.getElementById("fromDate").value||"1970-01-01").getTime();
  const to=new Date(document.getElementById("toDate").value||"2100-01-01").getTime();
  const filterT=document.getElementById("filterTicket").value.trim();
  const filterW=document.getElementById("filterWindow").value.trim();
  const filterM=document.getElementById("filterMRN").value.trim();

  const printedSnap=await db.ref(`${ROOT}/printed`).get();
  const data=[];
  for(const [n,val] of Object.entries(printedSnap.val()||{})){
    const num=Number(n);
    const printedTs = val.ts || val || "";
    if(!printedTs) continue;
    if(printedTs<from || printedTs>to) continue;
    if(filterT && n!=filterT) continue;

    const mrn=await getMrn(n);
    if(filterM && !mrn.includes(filterM)) continue;

    const {ts:callTs,window:win}=await getCallData(num);
    if(filterW && String(win)!=filterW) continue;

    const waitMin= (callTs && printedTs)? ((callTs-printedTs)/60000).toFixed(1):"";
    data.push({n,mrn,printedTs,callTs,win,waitMin});
  }

  tbody.innerHTML="";
  if(data.length===0){
    tbody.innerHTML="<tr><td colspan='6'>لا توجد بيانات</td></tr>";
    return;
  }

  for(const d of data){
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${d.n}</td>
      <td>${d.mrn||"-"}</td>
      <td>${formatTs(d.printedTs)}</td>
      <td>${formatTs(d.callTs)}</td>
      <td>${d.win||"-"}</td>
      <td>${d.waitMin||"-"}</td>
    `;
    tbody.appendChild(row);
  }
}

function formatTs(t){
  if(!t) return "-";
  const d=new Date(t);
  return d.toLocaleString("ar-SA",{hour12:false});
}

/* ========== Export CSV ========== */
function exportCSV(){
  const rows=[["رقم التذكرة","MRN","وقت الطباعة","وقت النداء","الشباك","مدة الانتظار (د)"]];
  document.querySelectorAll("#reportTable tbody tr").forEach(tr=>{
    const cols=[...tr.children].map(td=>td.innerText);
    rows.push(cols);
  });
  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="Report.csv"; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
