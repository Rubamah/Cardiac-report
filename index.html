<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiac Pharmacy Tickets — Realtime Dashboard</title>

<style>
  :root{
    --bg:#0b1320; --card:#111a2b; --ink:#eaf2ff; --muted:#94a3b8;
    --accent:#14b8a6; --border:#1f2a44; --head:#0f1626;
    --okbg:#0e2e2a; --okbd:#1a5e56; --oktx:#8ff3e5;
    --pbg:#2b2040; --pbd:#57468a; --ptx:#d3b3ff;
    --dbg:#3a1616; --dbd:#6b2323; --dtx:#ffb3b3;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:16px 18px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,#0f172a,#0b1320)}
  header h1{margin:0;font-size:20px;letter-spacing:.3px}
  .wrap{max-width:1400px;margin:auto;padding:18px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;color:var(--muted)}
  .stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .stat b{color:#fff}
  .filters{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end;margin-top:8px}
  .field{grid-column:span 3;background:var(--card);border:1px solid var(--border);padding:10px;border-radius:12px}
  .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .field input{width:100%;background:#0a1220;border:1px solid #23314f;color:var(--ink);padding:8px 10px;border-radius:8px;outline:none}
  .actions{grid-column:span 3;display:flex;gap:8px}
  button{border:1px solid var(--border);background:#0f1a2e;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .grid{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  thead th{position:sticky;top:0;background:var(--head);color:#bcd0f7;font-weight:700;text-align:center;padding:12px;border-bottom:1px solid #203056}
  tbody td{padding:10px 8px;border-bottom:1px solid #16213a;text-align:center;font-variant-numeric:tabular-nums}
  tr:hover td{background:#0e172a80}
  .badge{display:inline-block;padding:.2em .55em;border-radius:.6em;font-size:.85em}
  .ok{background:var(--okbg);color:var(--oktx);border:1px solid var(--okbd)}
  .pending{background:var(--pbg);color:var(--ptx);border:1px solid var(--pbd)}
  .danger{background:var(--dbg);color:var(--dtx);border:1px solid var(--dbd)}
  .foot{margin-top:10px;color:var(--muted);font-size:12px}
  .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#000c;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
  .overlay input{padding:10px 14px;font-size:18px;border-radius:10px;border:1px solid #333;text-align:center;margin-top:10px}
</style>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
<header><h1>لوحة المتابعة اللحظية — Cardiac Pharmacy Tickets</h1></header>

<div id="overlay" class="overlay">
  <h2>🔒 أدخل كلمة المرور</h2>
  <input id="pw" type="password" placeholder="Password" />
  <button onclick="checkPass()">دخول</button>
  <p id="msg" style="color:#f88;margin-top:8px"></p>
</div>

<div id="main" class="wrap" style="display:none">
  <div class="bar">
    <span class="stat">إجمالي التذاكر: <b id="statTotal">0</b></span>
    <span class="stat">المطبوعة: <b id="statPrinted">0</b></span>
    <span class="stat">المخدّمة: <b id="statServed">0</b></span>
    <span class="stat">قيد الانتظار: <b id="statWaiting">0</b></span>
  </div>

  <div class="filters">
    <div class="field"><label>بحث حسب MRN</label><input id="fMrn" placeholder="مثال: 123456" inputmode="numeric" /></div>
    <div class="field"><label>بحث حسب رقم التذكرة</label><input id="fTicket" placeholder="مثال: 87" inputmode="numeric" /></div>
    <div class="field"><label>التاريخ (حسب وقت الطباعة)</label><input id="fDate" type="date" /></div>
    <div class="actions">
      <button id="btnClear">مسح الفلاتر</button>
      <button id="btnExport">تصدير CSV</button>
    </div>
  </div>

  <div class="grid">
    <table>
      <thead><tr><th>Ticket</th><th>MRN</th><th>Printed Time</th><th>Served Time</th><th>Waiting Time</th><th>Status</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="foot">الحالة: <span class="badge ok">Served</span> / <span class="badge pending">Printed</span> / <span class="badge danger">No time</span>. التحديث لحظي.</div>
</div>

<script>
function checkPass(){
  const input = document.getElementById('pw').value.trim();
  if(input === 'PhReport'){
    document.getElementById('overlay').remove();
    document.getElementById('main').style.display='block';
    startApp();
  }else{
    document.getElementById('msg').textContent = '❌ كلمة المرور غير صحيحة';
  }
}

function startApp(){
  const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
  firebase.initializeApp(cfg);
  const db=firebase.database();
  const ROOT="cardiac_demo";

  const tbody=document.getElementById("tbody");
  const fMrn=document.getElementById("fMrn");
  const fTk=document.getElementById("fTicket");
  const fDate=document.getElementById("fDate");
  const statTotal=document.getElementById("statTotal");
  const statPrinted=document.getElementById("statPrinted");
  const statServed=document.getElementById("statServed");
  const statWaiting=document.getElementById("statWaiting");

  const rows=new Map();
  function zp(n){return n<10?'0'+n:n;}
  function fmt(d){return new Date(d).toLocaleString('sv').replace('T',' ');}
  function sameDate(a,b){if(!a||!b)return true;const d=new Date(a);return d.toISOString().slice(0,10)===b;}
  function coerce(x){if(!x)return null;if(typeof x==='number')return new Date(x).toISOString();if(x.ts)return new Date(x.ts).toISOString();return null;}
  function validServed(r){if(!r.tPrinted||!r.tServed)return false;return new Date(r.tServed)>=new Date(r.tPrinted);}
  function wTime(r){const p=r.tPrinted?new Date(r.tPrinted).getTime():NaN;const s=validServed(r)?new Date(r.tServed).getTime():Date.now();return Math.max(0,s-p);}
  function fmtDur(ms){const s=Math.floor(ms/1000);return `${zp(Math.floor(s/3600))}:${zp(Math.floor((s%3600)/60))}:${zp(s%60)}`;}

  function render(){
    const fmrn=fMrn.value.trim();const ft=fTk.value.trim();const fd=fDate.value;
    const arr=[...rows.values()].filter(r=>{
      if(fmrn && r.mrn && !r.mrn.includes(fmrn))return false;
      if(ft && r.ticket!=ft)return false;
      if(fd && r.tPrinted && !sameDate(r.tPrinted,fd))return false;
      return true;
    });
    arr.sort((a,b)=>(a.ticket-b.ticket));
    tbody.innerHTML=arr.map(r=>{
      const served=!!r.served||validServed(r);
      const printed=!!r.printed||!!r.tPrinted;
      const status=served?'Served':printed?'Printed':'No time';
      const badge=served?'ok':printed?'pending':'danger';
      const wt=fmtDur(wTime(r));
      return `<tr><td>${r.ticket}</td><td>${r.mrn||''}</td><td>${r.tPrinted?fmt(r.tPrinted):''}</td><td>${r.tServed?fmt(r.tServed):''}</td><td>${wt}</td><td><span class="badge ${badge}">${status}</span></td></tr>`;
    }).join('');
    statTotal.textContent=arr.length;
    statPrinted.textContent=arr.filter(r=>r.printed||r.tPrinted).length;
    statServed.textContent=arr.filter(r=>!!r.served||validServed(r)).length;
    statWaiting.textContent=arr.filter(r=>{
      const p=r.printed||r.tPrinted;const s=!!r.served||validServed(r);return p&&!s;
    }).length;
  }

  function upsert(id,chg){rows.set(id,{...rows.get(id)||{ticket:id},...chg});render();}

  db.ref(`${ROOT}/tickets`).on('value',s=>{s.forEach(c=>upsert(c.key,{mrn:c.val().mrn||''}));});
  db.ref(`${ROOT}/printed`).on('value',s=>{s.forEach(c=>upsert(c.key,{printed:true,tPrinted:coerce(c.val())}));});
  db.ref(`${ROOT}/served`).on('value',s=>{s.forEach(c=>upsert(c.key,{served:true}));});
  db.ref(`${ROOT}/calls`).on('value',s=>{s.forEach(c=>upsert(c.key,{tServed:coerce(c.val())}));});
}
</script>
</body>
</html>
